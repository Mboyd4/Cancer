---
title: "BestCancer"
author: "Ashley"
date: '2022-04-11'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Library
```{r}
library("tidyverse")
library("janitor")
library("hrbrthemes")
library("psych")
library("ggrepel")
library("ggplot2")
library("ggpubr")
library("broom")
library("AICcmodavg")
library("ctv") 
library("ape")
library("phytools")
library("phangorn")
library("geiger")
library("nlme")
library("ggtree")
library("visreg")
library("tidytree")
library("ggthemes")
```

Data
```{r}
lh <- read_csv("Pantheria_og.csv")
pi <- read.csv("placenta__more_interdigitation.csv")
np <- read.csv("neoplasiaPrevalence.min10.2022-04-01T19_13.csv")
tree <- ape::read.nexus("mammals_phylo.txt")
mammals <- read.newick("mammals_species.nwk")

```

Cleaning Data
```{r}
# Selecting & renaming variables
lh <- lh %>%
  clean_names()

# rename variable & convert from months to days
lh2 <- lh %>%
  select(msw93_binomial, x3_1_ageat_first_birth_d, x9_1_gestation_len_d, x14_1_inter_birth_interval_d, x15_1_litter_size, x16_1_litters_per_year, x17_1_max_longevity_m, x23_1_sexual_maturity_age_d)%>%
  rename(species = "msw93_binomial") %>%
  rename(agefb = "x3_1_ageat_first_birth_d") %>%
  rename(gestation = "x9_1_gestation_len_d") %>%
  rename(interv = "x14_1_inter_birth_interval_d") %>%
  rename(littersize = "x15_1_litter_size") %>%
  rename(litterpyr = "x16_1_litters_per_year") %>%
  rename(longev = "x17_1_max_longevity_m") %>%
  rename(sexmat = "x23_1_sexual_maturity_age_d")%>%
  mutate(longev *30)%>%
  rename(longevd = "longev * 30")

pi2 <- pi %>%
  select(species, placenta_invasiveness, X.4, interdigitation_placenta, X.5)

pi2$invade = pi2$X.4
pi2$invade[pi2$invade == "1"] <- "4"
pi2$invade[pi2$invade == "3"] <- "1"
pi2$invade[pi2$invade == "4"] <- "3"

pi2$digit = pi2$X.5
pi2$digit[pi2$digit == "1"] <- "4"
pi2$digit[pi2$digit == "3"] <- "1"
pi2$digit[pi2$digit == "4"] <- "3"

pi3 <- pi2 %>%
  select(species, placenta_invasiveness, invade, interdigitation_placenta, digit)

np2 <- np %>%
  select(KeepWildRecords.false, X.5, X.7, X.9, X.10, X.11) %>%
  rename(species = "KeepWildRecords.false") %>%
  rename(tot.neo = "X.5") %>%
  rename(prev.neo = "X.7") %>%
  rename(tot.mal = "X.9") %>%
  rename(prev.mal = "X.10") %>%
  rename(mal.trans = "X.11")

# Life history + placental invasion/interdigitation
combo1 <- merge(lh2, pi3, by= "species")

anticombo1 <- anti_join(lh2, pi3, by = "species")

# Life history + placental invasion/interdigitation + neoplasia/malignancy
megaset <- merge(combo1, np2, by= "species")

antimega <- anti_join(combo1, np2, by= "species")

# Filter out missing values
combo2 <- combo1 %>%
  filter(!agefb==-999.00) %>%
  filter(!gestation==-999.00) %>%
  filter(!gestation==-999.00) %>%
  filter(!interv==-999.00) %>%
  filter(!litterpyr==-999.00) %>%
  filter(!longev==-999.00) %>%
  filter(!sexmat==-999.00)
# Only 53 species with complete data!


# Life history + Cancer data
lifecancer <- merge(lh2, np2, by = "species")
lifecancer$tot.neo <- as.numeric(lifecancer$tot.neo)
lifecancer$prev.neo <- as.numeric(lifecancer$prev.neo)
lifecancer$tot.mal <- as.numeric(lifecancer$tot.mal)
lifecancer$prev.mal <- as.numeric(lifecancer$prev.mal)
lifecancer$mal.trans <- as.numeric(lifecancer$mal.trans)

# Placentas + Cancer data
placentacancer <- merge(pi3, np2, by = "species")


placentacancer1 <- placentacancer[-c(132),] 
placentacancer1$invade <- as.numeric(placentacancer1$invade)
placentacancer1$digit <- as.numeric(placentacancer1$digit)
placentacancer1$tot.neo <- as.numeric(placentacancer1$tot.neo)
placentacancer1$prev.neo <- as.numeric(placentacancer1$prev.neo)
placentacancer1$tot.mal <- as.numeric(placentacancer1$tot.mal)
placentacancer1$prev.mal <- as.numeric(placentacancer1$prev.mal)
placentacancer1$mal.trans <- as.numeric(placentacancer1$mal.trans)

placentacancer1$placenta_invasiveness[placentacancer1$placenta_invasiveness == "epi"] <- "Epitheliochorial"
placentacancer1$placenta_invasiveness[placentacancer1$placenta_invasiveness == "endo"] <- "Endotheliochorial"
placentacancer1$placenta_invasiveness[placentacancer1$placenta_invasiveness == "hemo"] <- "Hemochorial"


placentacancer2 <- placentacancer1 %>%
  mutate_all(funs(str_replace(.," ","_")))

# Phylo
species_placcancer <- placentacancer2 %>%
  dplyr::select("species")

mammal_phy <- ggtree(tree$mammalST_bestDates)

mammal_phy <- as.phylo(mammal_phy)

species_phylo <- as.data.frame(mammal_phy$tip.label) %>%
  rename("species"="mammal_phy$tip.label")

species_kept <- merge(species_phylo, species_placcancer, by.x = "species", by.y = "species")

species_kept_v <- as.vector(species_kept$species)

small_mammal_k <- keep.tip(mammal_phy,species_kept_v)

write.csv(species_kept_v,"species_kept_v.csv", row.names = FALSE, col.names = TRUE)
species_kept_p <- read.csv("species_kept_v.csv")

placenta_num <- merge(species_kept_p, placentacancer2, by.x = "x", by.y = "species") %>%
  rename("species"=x)

# Mammals
mammals_list <- as.phylo(mammals)

specmammal <- as.data.frame(mammals_list$tip.label)%>%
  rename("species"="mammals_list$tip.label")

specieslist <- merge(specmammal, species_placcancer, by.x = "species", by.y = "species")

specieslist_v <- as.vector(specieslist$species)

specieslist_k <- keep.tip(mammals, specieslist_v)

write.csv(specieslist_v, "specieslist_v.csv", row.names = FALSE, col.names = TRUE)

specieskept <- read.csv("specieslist_v.csv")

mammallist <- merge(specieskept, placentacancer2, by.x = "x", by.y = "species")%>%
  rename("species"=x)

mammallist1 <- mammallist
mammallist1[is.na(mammallist1)] <- 0

mammal.table <- as_tibble(mammals)
as.phylo(mammals)


# Trying another tutorial

x <- as_tibble(mammals) #tree as data table

data <- placentacancer2%>%
  rename("label"= species)

y <- merge(x, data, by= "label") #tree + placenta + cancer data as a table

str(y)

y$invade <- as.numeric(y$invade)
y$digit <- as.numeric(y$digit)
y$prev.neo <- as.numeric(y$prev.neo)
y$mal.trans <- as.numeric(y$mal.trans)

as.treedata(y)
```


Computations
```{r}
# Computing for births per lifetime:
#   Lifespan - age at sexual maturation (assumes no post-reproductive period) = Reproductive lifespan
combo2.1 <- combo2 %>%
  mutate(longevd - sexmat)%>%
  rename(reprolife = "longevd - sexmat") 

#   Gestation length + interbirth interval = Time per litter
combo2.2 <- combo2.1 %>%
  mutate(gestation + interv) %>%
  rename(timeprlit = "gestation + interv")

#   Reproductive lifespan / time per litter = Birthing potential
combo2.3 <- combo2.2 %>%
  mutate(reprolife / timeprlit) %>%
  rename(birthpotent = "reprolife/timeprlit")

# Computing for offspring output:
#   Maximum births per lifetime * Avg litter size
combo2.4 <- combo2.3 %>%
  mutate(birthpotent * littersize) %>%
  rename(maxoffspring = "birthpotent * littersize")



megaset5 <- merge(combo2.4, placentacancer1, by = "species")


```

Placental Invasion x Cancer ANOVAs
```{r}
# Malignant transformation as a function of placental invasion
pmtanova <- aov(mal.trans ~ invade, data = placentacancer1)

summary(pmtanova)

# Malignancy prevalence as a function of placental invasion
pmpanova <- aov(prev.mal ~ invade, data = placentacancer1)

summary(pmpanova)

# Neoplasia prevalence as a function of placental invasion
pnpanova <- aov(prev.neo ~ invade, data = placentacancer1)

summary(pnpanova)


```

Interdigitation x Cancer ANOVAs
```{r}
# Malignant transformation as a function of interdigitation
imtanova <- aov(mal.trans ~ digit, data = placentacancer1)

summary(imtanova)

# Malignancy prevalence as a function of interdigitation
impanova <- aov(prev.mal ~ digit, data = placentacancer1)

summary(impanova)

# Neoplasia prevalence as a function of interdigitation
inpanova <- aov(prev.neo ~ digit, data = placentacancer1)

summary(inpanova)
```

Invasion + Interdigitation ANOVAs (additive testing)
```{r}
# Malignant transformation as a function of invasion + interdigitation
pimtanova <- aov(mal.trans ~ invade + digit, data = placentacancer1)

summary(pimtanova)

# Malignancy prevalence as a function of invasion + interdigitation
pimpanova <- aov(prev.mal ~ invade + digit, data = placentacancer1)

summary(pimpanova)

# Neoplasia prevalence as a function of invasion + interdigitation
pinpanova <- aov(prev.neo ~ invade + digit, data = placentacancer1)

summary(pinpanova)
```

Invasion * Interdigitation ANOVAs (interaction testing)
```{r}
# Malignant transformation as a function of invasion * interdigitation
pimtanova1 <- aov(mal.trans ~ invade * digit, data = placentacancer1)

summary(pimtanova1)

# Malignancy prevalence as a function of invasion * interdigitation
pimpanova1 <- aov(prev.mal ~ invade * digit, data = placentacancer1)

summary(pimpanova1)

# Neoplasia prevalence as a function of invasion * interdigitation
pinpanova1 <- aov(prev.neo ~ invade * digit, data = placentacancer1)

summary(pinpanova1)
```

Invasion AICs
```{r}
# Malignant Transformation
mtset <- list(pmtanova, pimtanova, pimtanova1)
mtnames <- c("pmtanova", "pimtanova", "pimtanova1")

aictab(mtset, modnames = mtnames)
        #"pimtanova1",interaction model is the best fit.

par(mfrow=c(2,2))
plot(pimtanova1)
par(mfrow=c(1,1))



# Malignancy Prevalence
mpset <- list(pmpanova, pimpanova, pimpanova1)
mpnames <- c("pmpanova", "pimpanova", "pimpanova1")

aictab(mpset, modnames = mpnames)
      #"pimpanova", additive model is the best fit.

par(mfrow=c(2,2))
plot(pimpanova)
par(mfrow=c(1,1))


# Neoplasia Prevalence
npset <- list(pnpanova, pinpanova, pinpanova1)
npnames <- c("pnpanova", "pinpanova", "pinpanova1")

aictab(npset, modnames = npnames)
      #"pnpanova", solo model is the best fit

par(mfrow=c(2,2))
plot(pnpanova)
par(mfrow=c(1,1))


```

Interdigitation AICs
```{r}
# Malignant Transformation
mtsetd <- list(imtanova, pimtanova, pimtanova1)
mtnamesd <- c("imtanova", "pimtanova", "pimtanova1")

aictab(mtsetd, modnames = mtnamesd)
      #"imtanova", solo model is the best fit, interactive a close 2nd

par(mfrow=c(2,2))
plot(imtanova)
par(mfrow=c(1,1))

par(mfrow=c(2,2))
plot(pimtanova1)
par(mfrow=c(1,1))



# Malignancy Prevalence
mpsetd <- list(impanova, pimpanova, pimpanova1)
mpnamesd <- c("impanova", "pimpanova", "pimpanova1")

aictab(mpsetd, modnames = mpnamesd)
      #"impanova", solo model is the best fit

par(mfrow=c(2,2))
plot(impanova)
par(mfrow=c(1,1))



# Neoplasia Prevalence
npsetd <- list(inpanova, pinpanova, pinpanova1)
npnamesd <- c("inpanova", "pinpanova", "pinpanova1")

aictab(npsetd, modnames = npnamesd)
      #"inpanova", solo model is the best fit

par(mfrow=c(2,2))
plot(inpanova)
par(mfrow=c(1,1))
```

Tukey's HSD 
```{r}
# Malignant Transfromation as a function of the interaction of Placental Invasion & Interdigitation
#tukey.pimt <- TukeyHSD(pimtanova1)
#plot(tukey.pimts)

# Malignant Transformation as a function of Placental Interdigitation
#tukey.imt <- TukeyHSD(imtanova)
#plot(tukey.imt)




#Malignancy Prevalence as a function of added Invasion + Interdigitation
#tukey.pimp <- TukeyHSD(pimpanova)
#plot(tukey.pimp)

# Malignancy Prevalence as a function of Interdigitation
#tukey.imp <- TukeyHSD(impanova)
#plot(tukey.imp)




# Neoplasia Prevalence as a function of Placental Invasion
#tukey.pnp <- TukeyHSD(pnpanova)
#plot(tukey.pnp)

# Neoplasia Prevalence as a function of Interdigitation
#tukey.inp <- TukeyHSD(inpanova)
#plot(tukey.inp)
```

Birth Potential x Cancer ANOVAs (nothing significant)
```{r}
# Malignant transformation as a function of birth potential
bpmtanova <- aov(mal.trans ~ birthpotent, data = megaset5)

summary(bpmtanova)

# Malignancy prevalence as a function of birth potential
bpmpanova <- aov(prev.mal ~ birthpotent, data = megaset5)

summary(bpmpanova)

# Neoplasia prevalence as a function of birth potential
bpnpanova <- aov(prev.neo ~ birthpotent, data = megaset5)

summary(bpnpanova)

```

Maximum Offspring x Cancer ANOVAs (nothing significant)
```{r}
# Malignant transformation as a function of maximum offspring
momtanova <- aov(mal.trans ~ maxoffspring, data = megaset5)

summary(momtanova)

# Malignancy prevalence as a function of maximum offspring
mompanova <- aov(prev.mal ~ maxoffspring, data = megaset5)

summary(mompanova)

# Neoplasia prevalence as a function of maximum offspring
monpanova <- aov(prev.neo ~ maxoffspring, data = megaset5)

summary(monpanova)
```

Life history graphs
```{r}
# Lifespan x Time per litter x Placental invasion
combo2.4 %>%
  ggplot(.,aes(x=longevd, y=timeprlit, color= invade))+
  geom_point()+
  geom_smooth(method = "lm", se= FALSE)+
  geom_label_repel(aes(label = species))


# Lifespan x Time per litter x Interdigitation
combo2.4 %>%
  ggplot(.,aes(x=longevd, y=timeprlit, color= digit))+
  geom_point()+
  geom_smooth(method = "lm", se= FALSE)+
  geom_label_repel(aes(label = species))

# Maximum birth potential x Placental Invasion
combo2.4 %>%
  ggplot(., aes(y= birthpotent, x= placenta_invasiveness))+
  geom_boxplot()



```

Placentas & Cancer Graphs
```{r}

# Placental invasion x neoplasia prevalence
placentacancer1$placenta_invasiveness <- factor(placentacancer1$placenta_invasiveness,levels = c("Epitheliochorial", "Endotheliochorial", "Hemochorial"))

placentacancer1 %>%
  ggplot(.)+
  geom_violin(aes(x = placenta_invasiveness, y = prev.neo, fill=placenta_invasiveness))+
  ggtitle("Neoplasia Prevalence by Invasiveness")+
  xlab("Placental Invasion")+
  ylab("Neoplasia %")+
  theme_pander()+
  scale_fill_brewer()


# Interdigitation x neoplasia prevalence
placentacancer1$interdigitation_placenta <- factor(placentacancer1$interdigitation_placenta,levels = c("Villous", "Trabecular", "Labyrinthine"))


placentacancer1 %>%
  ggplot(.)+
  geom_violin(aes(x= interdigitation_placenta, y= prev.neo, fill=interdigitation_placenta))+
  ggtitle("Neoplasia Prevalence by Interdigitation")+
  xlab("Interdigitation Class")+
  ylab("Neoplasia %")+
  theme_pander()+
  scale_fill_brewer()


# Placental invasion x malignant transformation rate

placentacancer1 %>%
  ggplot(.)+
  geom_violin(aes(x= placenta_invasiveness, y= mal.trans, fill=placenta_invasiveness))+
  ggtitle("Rate of Malignant Transformation by Invasion")+
  xlab("Placental Invasion")+
  ylab("Rate of Malignant Transformation")+
  theme_pander(lp= "none")+
  scale_fill_brewer()

lacentacancer1 %>%
  ggplot(aes(x=placenta_invasiveness, y=mal.trans))+
  geom_point() +
  geom_smooth(method=lm , color="red", fill="#69b3a2", se=TRUE)


# Interdigitation x malignant transformation rate
placentacancer1 %>%
  ggplot(.)+
  geom_violin(aes(x= interdigitation_placenta, y= mal.trans, fill=interdigitation_placenta))+
  ggtitle("Rate of Malignant Transformation by Interdigitation")+
  xlab("Interdigitation Class")+
  ylab("Rate of Malignant Transformation")+
  theme_pander(lp="none")+
  scale_fill_brewer()






```

Birth Potential Graphs
```{r}
# Birth potential x interdigitation
combo2.4 %>%
  ggplot(.) +
  geom_boxplot(aes(x= interdigitation_placenta, y= birthpotent))

# Maximum offspring output x placental invasion
combo2.4 %>%
  ggplot(.) +
  geom_boxplot(aes(x= placenta_invasiveness, y= birthpotent))

# Maximum offspring output x neoplasia prevalence
megaset5 %>%
  ggplot(.)+
  geom_point(aes(x= birthpotent, y= prev.neo))

# Maximum offspring output x malignancy prevalence
megaset5 %>%
  ggplot(.)+
  geom_point(aes(x= birthpotent, y= prev.mal))

# Maximum offspring output x malignant transformation rate
megaset5 %>%
  ggplot(.)+
  geom_point(aes(x= birthpotent, y= mal.trans))
```

Placental Invasion x Cancer Correlation Computations
```{r}
# Placental Invasion x Malignant Transformation

invmal1 <- lm(placentacancer1$invade ~ placentacancer1$mal.trans)
summary(invmal1)

# Placental Invasion x Neoplasia Prevalence

invneo1 <- lm(placentacancer1$invade ~ placentacancer1$prev.neo)
summary(invneo1)

# Placental Invasion x Malignancy Prevalence

invmalprev1 <- lm(placentacancer1$invade ~ placentacancer1$prev.mal)
summary(invmalprev1)

```

Interdigitation Correlation x Cancer Computations
```{r}
# Interdigitation x Malignant Transformation

digmal1 <- lm(placentacancer1$digit ~ placentacancer1$mal.trans)
summary(digmal1)

# Interdigitation x Neoplasia Prevalence

digneo1 <- lm(placentacancer1$digit ~ placentacancer1$prev.neo)
summary(digneo1)

# Interdigitation x Malignancy Prevalence

digmalprev1 <- lm(placentacancer1$digit ~ placentacancer1$prev.mal)
summary(digmalprev1)

```

Life History x Cancer Correlation Computations
```{r}
# Lifespan x Malignant Transformation

longevdmal1 <- lm(lifecancer$longevd ~ lifecancer$mal.trans)
summary(longevdmal1)

# Lifespan x Neoplasia Prevalence

longevdneo1 <- lm(lifecancer$longevd ~ lifecancer$prev.neo)
summary(longevdneo1)

# Lifespan x Malignancy Prevalence

longevdmalprev1 <- lm(lifecancer$longevd ~ lifecancer$prev.mal)
summary(longevdmalprev1)




# Birth Potential x Malignant Transformation
birthpotmal <- lm(megaset5$birthpotent ~ megaset5$mal.trans)
summary(birthpotmal)

# Birth Potential x Neoplasia Prevalence
birthpotneo <- lm(megaset5$birthpotent ~ megaset5$prev.neo)
summary(birthpotneo)

# Birth Potential x Malignancy Prevalence
birthpotmalprev <- lm(megaset5$birthpotent ~ megaset5$prev.mal)
summary(birthpotmalprev)




# Max Offspring x Malignant Transformation
maxoffmal <- lm(megaset5$maxoffspring ~ megaset5$mal.trans)
summary(maxoffmal)

# Max Offspring x Neoplasia Prevalence
maxoffneo <- lm(megaset5$maxoffspring ~ megaset5$prev.neo)
summary(maxoffneo)

# Max Offspring x Malignancy Prevalence
maxoffmalprev <- lm(megaset5$maxoffspring ~ megaset5$prev.mal)
summary(maxoffmalprev)

```

Phylogeny
```{r}

# Malignant Transformation x Interdigitation
malig <- mammallist1[, "mal.trans"]
interdig <- mammallist1[, "digit"]

malig1 <- as.numeric(malig)
interdig1 <- as.numeric(interdig)

pgls_interdig <- gls(malig1 ~ interdig1, correlation = corBrownian(phy = mammals_list), data = mammallist, method = "ML")
summary(pgls_interdig)
coef(pgls_interdig)


anova.pgls.mti <- anova(pgls_interdig)


# Neoplasia Prevalence x Interdigitation
neop <- mammallist1[,"prev.neo"]

neop1 <- as.numeric(neop)

pgls_neointerdig <- gls(neop1 ~ interdig1, correlation = corBrownian(phy = mammals_list), data = mammallist, method = "ML")
summary(pgls_neointerdig)
coef(pgls_neointerdig)
pgls_neointerdig1 <- anova(pgls_neointerdig)
summary(pgls_neointerdig1)




# Malignant Transformation x Invasion
invasion <- mammallist1[, "invade"]
invasion1 <- as.numeric(invasion)

pgls_invasion <- gls(malig1 ~ invasion1, correlation = corBrownian(phy = mammals_list), data = mammallist, method = "ML")
summary(pgls_invasion)

pgls_invasion1 <- anova(pgls_invasion)
summary(pgls_invasion1)

invasion1.df <- as.data.frame(pgls_invasion1)


# Neoplasia Prevalence x Invasion
pgls_npinvade <- gls(neop1 ~ invasion1, correlation = corBrownian(phy = mammals_list), data = mammallist, method = "ML")
summary(pgls_npinvade)

npinvads.anova <- anova(pgls_npinvade)
summary(npinvads.anova)


# Neoplasia Prevalence x both
pgls_npboth <- gls(neop1 ~ invasion1*interdig1, correlation = corBrownian(phy = mammals_list), data = mammallist, method = "ML")
summary(pgls_npboth)


#Malignant Transformaiton by both
pgls_mtboth <- gls(malig1 ~ interdig1*invasion1, correlation = corBrownian(phy = mammals_list), data = mammallist, method = "ML")
summary(pgls_mtboth)
coef(pgls_mtboth)
```

```{r}
#mal.trans
pgls_litter <- gls(mal.trans ~ l, correlation = corBrownian(phy = mammals_list), data = y, method = "ML")
summary(pgls_npinvade)

```


```{r}
v <- vcv(mammals,  model = "Brownian", corr = TRUE)

z <- gls(x = mammallist$interdigitation_placenta, y = mammallist$mal.trans, v = v)

```

